<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Rain Altar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
  body {
    margin: 0;
    background: #0b0b0b;
    color: #6fa8dc;
    font-family: monospace;
    overflow: hidden;
  }

  #rain {
    position: fixed;
    inset: 0;
    pointer-events: none;
  }

  .drop {
    position: absolute;
    white-space: nowrap;
    opacity: 0.85;
    animation-timing-function: linear;
    animation-fill-mode: forwards;
  }

  @keyframes fall {
    from { transform: translate(0, -10px); }
    to { transform: translate(var(--drift), var(--fall-distance)); }
  }

  #input {
    position: fixed;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    border: 1px solid #333;
    color: #aaa;
    padding: 0.5rem;
    width: 80%;
    max-width: 400px;
    font-family: monospace;
    font-size: 16px;
  }
</style>
</head>

<body>

<div id="rain"></div>
<input id="input" type="text" placeholder="Offer a word to the rain" maxlength="60" />

<script>
const rain = document.getElementById("rain");

const VIEWPORT_HEIGHT = window.innerHeight;
const FALL_DISTANCE = VIEWPORT_HEIGHT * 1.1;

const rainGlyphs = [".", "/", "\\", "|", ":", "+", “*”, “!”];
const poem = [
  "water moves",
  "color waits",
  "rain becomes cloth",
  "held briefly",
  "falling without return"
];

// Create a single drop (letter or glyph)
function createDrop(text, xBase, speedMultiplier = 1) {
  const drop = document.createElement("div");
  drop.className = "drop";
  drop.textContent = text;

  const xOffset = Math.random() * 36 - 18;
  drop.style.left = (xBase + xOffset) + "px";

  const duration = (5 + Math.random() * 6) / speedMultiplier;
  const drift = (Math.random() * 70 - 35).toFixed(1) + "px";

  drop.style.setProperty("--drift", drift);
  drop.style.setProperty("--fall-distance", FALL_DISTANCE + "px");
  drop.style.animation = `fall ${duration}s linear forwards`;

  rain.appendChild(drop);

  const fadeStart = VIEWPORT_HEIGHT * 0.65;
  const fadeEnd = VIEWPORT_HEIGHT * 0.98;
  const startTime = performance.now();

  function update(time) {
    const elapsed = (time - startTime) / 1000;
    const progress = elapsed / duration;
    const y = progress * FALL_DISTANCE;

    if (y > fadeStart) {
      const t = Math.min((y - fadeStart) / (fadeEnd - fadeStart), 1);
      drop.style.opacity = (0.85 * (1 - t)).toFixed(2);

      if (Math.random() < t * 0.4) {
        drop.textContent = rainGlyphs[Math.floor(Math.random() * rainGlyphs.length)];
      }
    }

    if (elapsed < duration) requestAnimationFrame(update);
  }

  requestAnimationFrame(update);
  setTimeout(() => drop.remove(), duration * 1000);
}

// Random ASCII rain
function randomChar() {
  return rainGlyphs[Math.floor(Math.random() * rainGlyphs.length)];
}

// --- Layered rain ---
setInterval(() => {
  createDrop(randomChar(), Math.random() * window.innerWidth, 0.6);
}, 260);

setInterval(() => {
  createDrop(randomChar(), Math.random() * window.innerWidth, 1);
}, 120);

setInterval(() => {
  createDrop(randomChar(), Math.random() * window.innerWidth, 1.8);
}, 300);

// --- Poem lines: break into letters and disperse ---
setInterval(() => {
  const line = poem[Math.floor(Math.random() * poem.length)];
  const baseX = window.innerWidth / 2 + (Math.random() - 0.5) * window.innerWidth * 0.2;
  const letters = line.split("");
  letters.forEach((letter, i) => {
    setTimeout(() => {
      const speed = 0.8 + Math.random() * 0.5;
      createDrop(letter, baseX + (Math.random() * 12 - 6), speed);
    }, i * 100 + Math.random() * 80);
  });
}, 5000);

// --- User input: letters fall together, drift, fade ---
const input = document.getElementById("input");
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && input.value.trim() !== "") {
    const letters = input.value.split("");
    const center = window.innerWidth / 2;
    const spread = window.innerWidth * 0.18;
    const baseX = center + (Math.random() - 0.5 + Math.random() - 0.5) * spread;

    letters.forEach((letter, i) => {
      if (letter === " ") return;

      setTimeout(() => {
        createDrop(letter, baseX + (Math.random() * 12 - 6), 0.85 + Math.random() * 0.5);
      }, i * 140 + Math.random() * 120);
    });

    input.value = "";
  }
});
</script>

</body>
</html>
